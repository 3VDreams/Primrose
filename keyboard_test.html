<!DOCTYPE html>
<!--
Copyright (C) 2015 Sean T. McBeth <sean@seanmcbeth.com>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
    <head>
        <title>Test keyCodes</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <select id="c"></select>
        <input id="v" type="text" placeholder="code page name">
        <input id="n" type="text" placeholder="friendly name">
        <input id="l" type="text" placeholder="language code"><br>
        <input id="x" type="text" placeholder="type codes here"><br>
        <div id="t" style="font-family:monospace; font-size:10pt;white-space: pre; column-count: 3;-webkit-column-count: 3;-moz-column-count: 3;"></div>
        <script type="text/javascript" src="src/core.js"></script>
        <script type="text/javascript" src="src/Keys.js"></script>
        <script type="text/javascript" src="src/code_pages/EN_US.js"></script>
        <script type="text/javascript" src="src/code_pages/EN_UKX.js"></script>
        <script type="text/javascript" src="src/code_pages/FR_AZERTY.js"></script>
        <script type="text/javascript">
            var t = document.getElementById("t");
            var v = document.getElementById("v");
            var n = document.getElementById("n");
            var l = document.getElementById("l");
            var x = document.getElementById("x");

            var codePage;
            function setCodePage(cp) {
                codePage = cp;
                if (codePage) {
                    for (var key in CodePages) {
                        if (CodePages[key].name === codePage.name) {
                            v.value = key;
                            n.value = CodePages[key].name;
                            l.value = CodePages[key].language;
                            break;
                        }
                    }
                }
                else {
                    codePage = {};
                    n.value = "";
                    l.value = "";
                }
                drawPage();
            }
            setCodePage(CodePages.EN_US);
            var c = makeSelectorFromObj("c", CodePages, codePage.name, window, "setCodePage");

            v.addEventListener("change", function () {
                setCodePage(CodePages[v.value]);
            });
            
            n.addEventListener("change", function(){
                codePage = codePage || {};
                codePage.name = n.value;
                drawPage();
            });
            
            l.addEventListener("change", function(){
                codePage = codePage || {};
                codePage.language = l.value;
                drawPage();
            });

            function drawPage() {
                t.value = "CodePages." + v.value + " = {\n";
                for (var key in codePage) {
                    t.value += "    " + key + ": ";
                    var val = codePage[key];
                    var typ = typeof (val);
                    if (typ === "string" || typ === "number") {
                        t.value += "\"" + val + "\",\n";
                    }
                    else {
                        t.value += "{\n";
                        for (var name in val) {
                            console.log(name, val[name]);
                            var val2 = val[name];
                            if(val2 instanceof Function){
                                val2 = val2.toString();
                            }
                            else{
                                val2 = "\"" + val2.replace(/\\/g, "\\\\").replace(/"/g, "\\\"") + "\"";
                            }
                            t.value += "        \"" + name + "\": " + val2 + ",\n";
                        }
                        t.value += "    },\n";
                    }
                }
                t.value += "};";
                t.textContent = t.value;
                t.innerText = t.value;
            }
            var commandName, code;
            x.addEventListener("keydown", function (evt) {
                if (evt.location === 0) {
                    commandName = "";
                    if (evt.ctrlKey) {
                        commandName += "CTRL";
                    }
                    if (evt.altKey) {
                        commandName += "ALT";
                    }
                    if (evt.metaKey) {
                        commandName += "META";
                    }
                    if (evt.shiftKey) {
                        commandName += "SHIFT";
                    }
                    if (commandName === "") {
                        commandName += "NORMAL";
                    }
                    code = evt.keyCode;
                    x.value = "";
                }
            });

            x.addEventListener("keyup", function (evt) {
                if (evt.keyCode !== 8
                        && evt.keyCode !== 16
                        && evt.keyCode !== 17
                        && evt.keyCode !== 18
                        && evt.keyCode !== 91) {
                    if(!codePage[commandName]){
                        codePage[commandName] = {};
                    }
                    codePage[commandName][code] = x.value;
                    x.value = code;
                    drawPage();
                }
            });
            
            window.addEventListener("copy", function(evt){
                var str = t.textContent || t.innerText;
                evt.clipboardData.setData("text/plain", str);
                evt.preventDefault();
            });
        </script>
    </body>
</html>
