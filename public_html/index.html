<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0">
        <title>Primrose: Canvas-based text editor</title>
        <style type="text/css">
            body{
                background-color: #eee;
            }
            #output{
                border:dashed 3px red;
            }
            #clipboard-container {
                position: fixed;
                left: 0px;
                top: 0px;
                width: 0px;
                height: 0px;
                z-index: 100;
                display: none;
                opacity: 0;
            }
            #clipboard {
                width: 1px;
                height: 1px;       
                padding: 0px;
            }
        </style>
        <style type="text/css" id="testStyle">
            #testDoc{
                font-family: monospace;
                color:black;
            }
            #testDoc .keyword{
                color: blue;
            }
            #testDoc .identifier{
                color: #aa0000;
                font-weight: bold;
            }
            #testDoc .stringLiteral{
                color: #aa9900;
                font-style: italic;
            }
            #testDoc .comment{
                color: green;
                font-style: italic;
            }
            #testDoc .openParen, .closeParen, .openBrace, .closeBrace{
                color: black;
            }
        </style>
        <script type="text/javascript" src="js/core.js"></script>
        <script type="text/javascript" src="js/testing.js"></script>
        <script type="text/javascript" src="js/Rope.js"></script>
        <script type="text/javascript" src="js/Grammar.js"></script>
        <script type="text/javascript" src="js/Tokenizer.js"></script>
        <script type="text/javascript">
            consoleTest(Rope);
        </script>
    </head>
    <body>
        <canvas id="output" width="690" height="300"></canvas>
        <div id="clipboard-container"><textarea id="clipboard"></textarea></div>
        <script type="text/javascript">
            var data = new Rope("function Hello (){\n"
                    + "    // a comment\n"
                    + "    function MyFunc ( ) {\n"
                    + "        var x = \"Whatever\";\n"
                    + "        console.log(x + \" World\");\n"
                    + "        /*\n"
                    + "          a longer comment\n"
                    + "        */\n"
                    + "    }\n"
                    + "}");
            var testDoc = document.getElementById("testDoc");
            var output = document.getElementById("output");
            var graphics = output.getContext("2d");
            var CHAR_HEIGHT = 20;
            var pixelRatio = window.devicePixelRatio || 1;
            CHAR_HEIGHT *= pixelRatio;
            output.style.width = output.width + "px";
            output.style.height = output.height + "px";
            output.width = output.width * pixelRatio;
            output.height = output.height * pixelRatio;
            var LINE_HEIGHT = CHAR_HEIGHT * 1.25;
            var cursor = {x: 0, y: 0, start: 0, end: 0};
            graphics.font = CHAR_HEIGHT + "px monospace";
            var CHAR_WIDTH = graphics.measureText("M").width;
            var testStyleSheet = null;
            for (var i = 0; i < document.styleSheets.length; ++i) {
                var s = document.styleSheets[i];
                if (s.ownerNode.id === "testStyle") {
                    testStyleSheet = s;
                    break;
                }
            }

            function drawText() {
                var text = data.toString();
                graphics.clearRect(0, 0, graphics.canvas.width, graphics.canvas.height);
                var x = 0, y = 0;
                for(var i = 0; i < text.length; ++i){
                    var char = text[i];
                    if (char === "\n") {
                        ++y;
                        x = 0;
                    }
                    else {
                        if (cursor.start <= i && i < cursor.end) {
                            graphics.fillStyle = "#c0c0c0";
                            graphics.fillRect(
                                    x * CHAR_WIDTH, (y + 0.25) * CHAR_HEIGHT,
                                    CHAR_WIDTH, CHAR_HEIGHT
                                    );
                        }

                        if (char !== " ") {
                            /*
                             var font = ((cur.totalStyle["font-weight"] || "")
                             + " "
                             + (cur.totalStyle["font-style"] || "")
                             + " "
                             + CHAR_HEIGHT
                             + "px monospace").trim();
                             */
                            var font = CHAR_HEIGHT + "px monospace";
                            graphics.font = font;
                            //graphics.fillStyle = cur.totalStyle.color;
                            graphics.fillStyle = "black";
                            graphics.fillText(char, x * CHAR_WIDTH, (y + 1) * CHAR_HEIGHT);
                        }
                        ++x;
                    }
                }
                
                graphics.beginPath();
                graphics.strokeStyle = "black";
                graphics.moveTo(cursor.x * CHAR_WIDTH, cursor.y * CHAR_HEIGHT);
                graphics.lineTo(cursor.x * CHAR_WIDTH, (cursor.y + 1.25) * CHAR_HEIGHT);
                graphics.moveTo(cursor.x * CHAR_WIDTH + 1, cursor.y * CHAR_HEIGHT);
                graphics.lineTo(cursor.x * CHAR_WIDTH + 1, (cursor.y + 1.25) * CHAR_HEIGHT);
                graphics.stroke();
            }

            function editText(evt) {
                // these values should be cached, rather than recalculating
                // them every time.
                var text = data.toString();                
                var lines = text.split(/\n/g);                
                var key = event.keyCode || event.which;
                evt.preventDefault();
                if (key === Keys.LEFTARROW) {
                    if(evt.shiftKey){
                        --cursor.end;
                    }
                    else{
                        --cursor.start;
                        cursor.end = cursor.start;
                        --cursor.x;
                        if(cursor.x < 0){
                            --cursor.y;
                            cursor.x = lines[cursor.y].length;
                        }
                    }
                }
                else if (key === Keys.RIGHTARROW && cursor.start < text.length) {
                    if(evt.shiftKey){
                        ++cursor.end;
                    }
                    else{
                        ++cursor.start;
                        cursor.end = cursor.start;
                        ++cursor.x;
                        if(cursor.x > lines[cursor.y].length){
                            cursor.x = 0;
                            ++cursor.y;
                        }
                    }
                }
                else if (key === Keys.UPARROW && cursor.y > 0) {
                    if(evt.shiftKey){
                        // this is not right
                        cursor.end -= lines[cursor.y - 1].length - cursor.x;
                    }
                    else{
                        --cursor.y;
                        cursor.x = Math.min(lines[cursor.y].length, cursor.x);
                        cursor.start -= lines[cursor.y].length - cursor.x;
                        cursor.end = cursor.start;
                    }
                }
                else if (key === Keys.DOWNARROW && cursor.y < lines.length) {
                    if(evt.shiftKey){
                        cursor.end += lines[cursor.y].length;
                    }
                    else{
                        cursor.start += lines[cursor.y].length;
                        cursor.end = cursor.start;
                        ++cursor.y;
                        cursor.x = Math.min(lines[cursor.y].length, cursor.x);
                    }
                }
                else if(key !== Keys.SHIFT && key !== Keys.CTRL && key !== Keys.ALT){
                    if(cursor.start !== cursor.end){
                        data.delete(
                            Math.min(cursor.start, cursor.end),
                            Math.max(cursor.start, cursor.end));
                    }
                    cursor.end = cursor.start;
                    if (key === Keys.BACKSPACE && cursor.start === cursor.end){
                        data.delete(cursor.start - 1, cursor.start);
                        --cursor.start;
                    }
                    else if (key === Keys.DELETE && cursor.start === cursor.end){
                        data.delete(cursor.start, cursor.start + 1);
                    }
                    else if (key === Keys.ENTER) {
                        var indent = "";
                        while (lines[cursor.y][cursor.x] === " ") {
                            indent += " ";
                        }                        
                        data.insert(cursor.start, "\n" + indent);
                        ++cursor.start;
                        ++cursor.y;
                        cursor.x = indent.length;
                    }
                    else if (event.shiftKey && Keys.UPPERCASE[key]) {
                        data.insert(cursor.start, Keys.UPPERCASE[key]);
                        ++cursor.start;
                        ++cursor.x;
                    }
                    else if (!event.shiftKey && Keys.LOWERCASE[key]) {
                        data.insert(cursor.start, Keys.LOWERCASE[key]);
                        ++cursor.start;
                        ++cursor.x;
                    }
                    else {
                        console.log(event.keyCode);
                    }
                }
            }

            window.addEventListener("keydown", function (evt) {
                editText(evt);
                drawText();
            });

            drawText();

            var dragging = false;
            output.addEventListener("mousedown", function (evt) {
                var lines = testText.split("\n");
                cursor.y = Math.max(0, Math.min(lines.length - 1, Math.floor((evt.layerY * pixelRatio / CHAR_HEIGHT) - 0.25)));
                cursor.x = Math.max(0, Math.min(lines[cursor.y].length, Math.floor(evt.layerX * pixelRatio / CHAR_WIDTH)));
                drawText();
                dragging = true;
            });
            output.addEventListener("mouseup", function (evt) {
                dragging = false;
            });

            output.addEventListener("mousemove", function (evt) {
                if (dragging) {
                    var lines = testText.split("\n");
                    var y = Math.max(0, Math.min(lines.length - 1, Math.floor(evt.layerY * pixelRatio / CHAR_HEIGHT)));
                    var x = Math.max(0, Math.min(lines[cursor.y].length, Math.floor(evt.layerX * pixelRatio / CHAR_WIDTH)));
                    var t = 0;
                    if (y < cursor.y || y === cursor.y && x < cursor.x) {
                        t = cursor.y;
                        cursor.y = y;
                        y = t;
                        t = cursor.x;
                        cursor.x = x;
                        x = t;
                    }
                    cursor.len = x - cursor.x;
                    for (var i = cursor.y; i < y; ++i) {
                        cursor.len += lines[i].length + 1;
                    }
                    refresh();
                }
            });

            var Keys = {};
            Keys.BACKSPACE = 8;
            Keys.TAB = 9;
            Keys.ENTER = 13;
            Keys.SHIFT = 16;
            Keys.CTRL = 17;
            Keys.ALT = 18;
            Keys.PAUSEBREAK = 19;
            Keys.CAPSLOCK = 20;
            Keys.ESCAPE = 27;
            Keys.SPACEBAR = 32;
            Keys.PAGEUP = 33;
            Keys.PAGEDOWN = 34;
            Keys.END = 35;
            Keys.HOME = 36;
            Keys.LEFTARROW = 37;
            Keys.UPARROW = 38;
            Keys.RIGHTARROW = 39;
            Keys.DOWNARROW = 40;
            Keys.INSERT = 45;
            Keys.DELETE = 46;
            Keys.NUMBER0 = 48;
            Keys.NUMBER1 = 49;
            Keys.NUMBER2 = 50;
            Keys.NUMBER3 = 51;
            Keys.NUMBER4 = 52;
            Keys.NUMBER5 = 53;
            Keys.NUMBER6 = 54;
            Keys.NUMBER7 = 55;
            Keys.NUMBER8 = 56;
            Keys.NUMBER9 = 57;
            Keys.A = 65;
            Keys.B = 66;
            Keys.C = 67;
            Keys.D = 68;
            Keys.E = 69;
            Keys.F = 70;
            Keys.G = 71;
            Keys.H = 72;
            Keys.I = 73;
            Keys.J = 74;
            Keys.K = 75;
            Keys.L = 76;
            Keys.M = 77;
            Keys.N = 78;
            Keys.O = 79;
            Keys.P = 80;
            Keys.Q = 81;
            Keys.R = 82;
            Keys.S = 83;
            Keys.T = 84;
            Keys.U = 85;
            Keys.V = 86;
            Keys.W = 87;
            Keys.X = 88;
            Keys.Y = 89;
            Keys.Z = 90;
            Keys.LEFTWINDOWKEY = 91;
            Keys.RIGHTWINDOWKEY = 92;
            Keys.SELECTKEY = 93;
            Keys.NUMPAD0 = 96;
            Keys.NUMPAD1 = 97;
            Keys.NUMPAD2 = 98;
            Keys.NUMPAD3 = 99;
            Keys.NUMPAD4 = 100;
            Keys.NUMPAD5 = 101;
            Keys.NUMPAD6 = 102;
            Keys.NUMPAD7 = 103;
            Keys.NUMPAD8 = 104;
            Keys.NUMPAD9 = 105;
            Keys.MULTIPLY = 106;
            Keys.ADD = 107;
            Keys.SUBTRACT = 109;
            Keys.DECIMALPOINT = 110;
            Keys.DIVIDE = 111;
            Keys.F1 = 112;
            Keys.F2 = 113;
            Keys.F3 = 114;
            Keys.F4 = 115;
            Keys.F5 = 116;
            Keys.F6 = 117;
            Keys.F7 = 118;
            Keys.F8 = 119;
            Keys.F9 = 120;
            Keys.F10 = 121;
            Keys.F11 = 122;
            Keys.F12 = 123;
            Keys.NUMLOCK = 144;
            Keys.SCROLLLOCK = 145;
            Keys.SEMICOLON = 186;
            Keys.EQUALSIGN = 187;
            Keys.COMMA = 188;
            Keys.DASH = 189;
            Keys.PERIOD = 190;
            Keys.FORWARDSLASH = 191;
            Keys.GRAVEACCENT = 192;
            Keys.OPENBRACKET = 219;
            Keys.BACKSLASH = 220;
            Keys.CLOSEBRACKET = 221;
            Keys.SINGLEQUOTE = 222;

            Keys.LOWERCASE = {};
            Keys.LOWERCASE[Keys.A] = "a";
            Keys.LOWERCASE[Keys.B] = "b";
            Keys.LOWERCASE[Keys.C] = "c";
            Keys.LOWERCASE[Keys.D] = "d";
            Keys.LOWERCASE[Keys.E] = "e";
            Keys.LOWERCASE[Keys.F] = "f";
            Keys.LOWERCASE[Keys.G] = "g";
            Keys.LOWERCASE[Keys.H] = "h";
            Keys.LOWERCASE[Keys.I] = "i";
            Keys.LOWERCASE[Keys.J] = "j";
            Keys.LOWERCASE[Keys.K] = "k";
            Keys.LOWERCASE[Keys.L] = "l";
            Keys.LOWERCASE[Keys.M] = "m";
            Keys.LOWERCASE[Keys.N] = "n";
            Keys.LOWERCASE[Keys.O] = "o";
            Keys.LOWERCASE[Keys.P] = "p";
            Keys.LOWERCASE[Keys.Q] = "q";
            Keys.LOWERCASE[Keys.R] = "r";
            Keys.LOWERCASE[Keys.S] = "s";
            Keys.LOWERCASE[Keys.T] = "t";
            Keys.LOWERCASE[Keys.U] = "u";
            Keys.LOWERCASE[Keys.V] = "v";
            Keys.LOWERCASE[Keys.W] = "w";
            Keys.LOWERCASE[Keys.X] = "x";
            Keys.LOWERCASE[Keys.Y] = "y";
            Keys.LOWERCASE[Keys.Z] = "z";
            Keys.LOWERCASE[Keys.SPACEBAR] = " ";
            Keys.LOWERCASE[Keys.NUMBER0] = "0";
            Keys.LOWERCASE[Keys.NUMBER1] = "1";
            Keys.LOWERCASE[Keys.NUMBER2] = "2";
            Keys.LOWERCASE[Keys.NUMBER3] = "3";
            Keys.LOWERCASE[Keys.NUMBER4] = "4";
            Keys.LOWERCASE[Keys.NUMBER5] = "5";
            Keys.LOWERCASE[Keys.NUMBER6] = "6";
            Keys.LOWERCASE[Keys.NUMBER7] = "7";
            Keys.LOWERCASE[Keys.NUMBER8] = "8";
            Keys.LOWERCASE[Keys.NUMBER9] = "9";
            Keys.LOWERCASE[Keys.MULTIPLY] = "*";
            Keys.LOWERCASE[Keys.ADD] = "+";
            Keys.LOWERCASE[Keys.SUBTRACT] = "-";
            Keys.LOWERCASE[Keys.DECIMALPOINT] = ".";
            Keys.LOWERCASE[Keys.DIVIDE] = "/";
            Keys.LOWERCASE[Keys.SEMICOLON] = ";";
            Keys.LOWERCASE[Keys.EQUALSIGN] = "=";
            Keys.LOWERCASE[Keys.COMMA] = ",";
            Keys.LOWERCASE[Keys.DASH] = "-";
            Keys.LOWERCASE[Keys.PERIOD] = ".";
            Keys.LOWERCASE[Keys.FORWARDSLASH] = "/";
            Keys.LOWERCASE[Keys.GRAVEACCENT] = "`";
            Keys.LOWERCASE[Keys.OPENBRACKET] = "[";
            Keys.LOWERCASE[Keys.BACKSLASH] = "\\";
            Keys.LOWERCASE[Keys.CLOSEBRACKET] = "]";
            Keys.LOWERCASE[Keys.SINGLEQUOTE] = "'";

            Keys.UPPERCASE = {};
            Keys.UPPERCASE[Keys.A] = "A";
            Keys.UPPERCASE[Keys.B] = "B";
            Keys.UPPERCASE[Keys.C] = "C";
            Keys.UPPERCASE[Keys.D] = "D";
            Keys.UPPERCASE[Keys.E] = "E";
            Keys.UPPERCASE[Keys.F] = "F";
            Keys.UPPERCASE[Keys.G] = "G";
            Keys.UPPERCASE[Keys.H] = "H";
            Keys.UPPERCASE[Keys.I] = "I";
            Keys.UPPERCASE[Keys.J] = "J";
            Keys.UPPERCASE[Keys.K] = "K";
            Keys.UPPERCASE[Keys.L] = "L";
            Keys.UPPERCASE[Keys.M] = "M";
            Keys.UPPERCASE[Keys.N] = "N";
            Keys.UPPERCASE[Keys.O] = "O";
            Keys.UPPERCASE[Keys.P] = "P";
            Keys.UPPERCASE[Keys.Q] = "Q";
            Keys.UPPERCASE[Keys.R] = "R";
            Keys.UPPERCASE[Keys.S] = "S";
            Keys.UPPERCASE[Keys.T] = "T";
            Keys.UPPERCASE[Keys.U] = "U";
            Keys.UPPERCASE[Keys.V] = "V";
            Keys.UPPERCASE[Keys.W] = "W";
            Keys.UPPERCASE[Keys.X] = "X";
            Keys.UPPERCASE[Keys.Y] = "Y";
            Keys.UPPERCASE[Keys.Z] = "Z";
            Keys.UPPERCASE[Keys.SPACEBAR] = " ";
            Keys.UPPERCASE[Keys.NUMBER0] = ")";
            Keys.UPPERCASE[Keys.NUMBER1] = "!";
            Keys.UPPERCASE[Keys.NUMBER2] = "@";
            Keys.UPPERCASE[Keys.NUMBER3] = "#";
            Keys.UPPERCASE[Keys.NUMBER4] = "$";
            Keys.UPPERCASE[Keys.NUMBER5] = "%";
            Keys.UPPERCASE[Keys.NUMBER6] = "^";
            Keys.UPPERCASE[Keys.NUMBER7] = "&";
            Keys.UPPERCASE[Keys.NUMBER8] = "*";
            Keys.UPPERCASE[Keys.NUMBER9] = "(";
            Keys.UPPERCASE[Keys.MULTIPLY] = "*";
            Keys.UPPERCASE[Keys.ADD] = "+";
            Keys.UPPERCASE[Keys.SUBTRACT] = "-";
            Keys.UPPERCASE[Keys.DECIMALPOINT] = ".";
            Keys.UPPERCASE[Keys.DIVIDE] = "/";
            Keys.UPPERCASE[Keys.SEMICOLON] = ":";
            Keys.UPPERCASE[Keys.EQUALSIGN] = "+";
            Keys.UPPERCASE[Keys.COMMA] = "<";
            Keys.UPPERCASE[Keys.DASH] = "_";
            Keys.UPPERCASE[Keys.PERIOD] = ">";
            Keys.UPPERCASE[Keys.FORWARDSLASH] = "?";
            Keys.UPPERCASE[Keys.GRAVEACCENT] = "~";
            Keys.UPPERCASE[Keys.OPENBRACKET] = "{";
            Keys.UPPERCASE[Keys.BACKSLASH] = "|";
            Keys.UPPERCASE[Keys.CLOSEBRACKET] = "}";
            Keys.UPPERCASE[Keys.SINGLEQUOTE] = "\"";
        </script>
    </body>
</html>